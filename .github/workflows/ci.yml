# .github/workflows/ci.yml
name: FastAPI CI/CD Pipeline

# Controls when the workflow will run
on:
  push:
    branches: [ "main", "develop" ] # Runs on pushes to main or develop
  pull_request:
    branches: [ "main", "develop" ] # Runs on pull requests targeting main or develop

jobs:
  build-and-test:
    name: Build, Lint, and Test
    runs-on: ubuntu-latest # Specifies the type of runner

    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.13"] # Added Python 3.13

    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Python environment
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip' # Cache pip dependencies

      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # If you have a separate dev requirements for linters/pytest:
          # pip install -r requirements-dev.txt

      # Step 4: Lint with Flake8
      # Flake8 should now be installed via requirements.txt
      - name: Lint with Flake8
        run: |
          # python -m pip install flake8 # This line can be commented out if flake8 is in requirements.txt
          echo "Running Flake8..."
          # This command will fail the job if Flake8 finds issues.
          flake8 . --count --max-complexity=12 --max-line-length=119 --show-source --statistics

      # Step 5: Format with Black (Check Mode)
      # Black should now be installed via requirements.txt
      - name: Check formatting with Black
        run: |
          # python -m pip install black # This line can be commented out if black is in requirements.txt
          black --check .
        # This step will fail if Black finds files that need reformatting.

      # Step 6: Test with Pytest
      # Pytest and pytest-cov should be in requirements.txt
      - name: Test with Pytest
        run: |
          pytest test/ --cov=app --cov-report=xml --cov-report=term-missing
          # Adjust 'test/' to your actual test directory name if different (e.g., 'tests/')

      # Step 7: Build Docker image (verifies Dockerfile is working)
      - name: Build Docker image
        if: success() # Only run if previous steps were successful
        run: |
          docker build . --file Dockerfile --tag your-app-name:${{ github.sha }}
          # Replace 'your-app-name' with a suitable name for your application image (e.g., my-todo-app)

  # Optional Job: Push Docker image to GitHub Container Registry (GHCR)
  push-to-ghcr:
    name: Push Docker Image to GHCR
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push Docker image to GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/your-app-name:latest
            ghcr.io/${{ github.repository_owner }}/your-app-name:${{ github.sha }}
            # IMPORTANT: Replace 'your-app-name' with your actual image name.
            # e.g., ghcr.io/ariandokoohaki/todo-app:latest

  # Placeholder for Deployment Job
  # deploy-to-production:
  #   name: Deploy to Production
  #   needs: push-to-ghcr
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   steps:
  #     - name: Deploy to Cloud Provider
  #       run: |
  #         echo "Deploying image ghcr.io/${{ github.repository_owner }}/your-app-name:${{ github.sha }} to production..."
